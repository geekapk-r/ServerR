# 基本法

## 哪些是通知

GeekApk 里，_通知_ 作为一种对 _用户_ 的提醒而存在，一般在 __动作执行后__ 直接保存等待用户阅读，GeekApk 中有这些通知：

+ _用户_ 的 _评论_ 被 __回复__ 的通知
+ _用户_ 被 `@` __提到__ 的通知
+ _用户_ 被 _用户_ __跟随__ 的通知
+ _用户_ 的 _评论_ 被 __星标__ 的通知

## Timeline（时间线）

类似 _GitHub_，GeekApk 也会记录每个 _用户_ 的公开活动并允许所有人自由查询，这个特性被称为 __Timeline（时间线）__，GeekApk 中有这些时间线记录：

+ _用户_ __Follow__ 了某个 _用户_
+ _用户_ __Star__ 了某个 _评论_
+ _用户_ __创建了__ 某个 _评论_
+ _用户_ __更新了__ 某个 _评论_
+ _用户_ __发布了__ 某个 _应用_
+ _用户_ __发布了__ 某个 _应用_ 的 _更新_
+ _用户_ __删除了__ 某个 _应用_
+ _用户_ __Star__ 了某个 _应用_

## WebHooks

GeekApk 可以与 _第三方服务_ 进行 __集成__，服务端使用的支持方式就是 _WebHooks_

_WebHooks_ 可以让 GeekApk 服务器在进行某种操作后 __通知__ 外部服务进行相应的处理

GeekApk 目前支持 __3__ 种 _WebHooks_：

+ __replyToMessage__ 在回复指定 _评论_ 时触发
+ __commentApp__ 在回复指定 _应用_ 时触发
+ __newUser__ 在添加一个 _用户_ 时触发

GeekApk 服务器内部使用 _环境变量_ 存储 _WebHooks_ 设置，同时，要应用新 _WebHooks_ 设置需要 __重启服务器__

```ruby
WEBHOOKS='replyToMessage:2333:https://bar.org/bot;commentApp:23:https://geekbot.com/webhook;newUser:https://webhooks.org/bot;'
```

触发时 GeekApk 服务器使用 `POST` 为 _HTTP 方法_，相应 _对象_ 的 _ID_ 为 _POST body_ 请求目标地址

如果请求失败，错误记录只会被打印在服务程序的 _标准错误输出_ 里

## 身份验证和权限管理

GeekApk 使用 __基于角色__ 的权限系统，验证需要的令牌保存在 _cookie_ 里

GeekApk 有以下 __3__ 种角色：

+ __权限汪__ :dog:（确信）
+ __用户__
+ __未登录用户__

无论是 __权限汪__、__用户__ 还是 __未登录用户__ 实体都可以有多个

### 权限细则

#### 权限汪（独立于用户的概念） < 未登录用户

权限汪不一定需要有一个 _GeekApk 账户_，实际上，权限汪只需要服务器的 __管理令牌__ 就可以验证自己的身份

这也意味着权限汪其实只代表了 GeekApk _管理人员_ 比 _普通用户_ __多__ 的权限，但它没有普通用户所拥有的权限 ~~233~~

+ 权限汪可以创建/删除 _用户_
+ 权限汪可以修改 _用户_ 的 _分发密码_
+ 权限汪可以停用/激活 _用户_
+ 权限汪可以创建/修改/删除 _分类_
+ 权限汪可以删除 _评论_
+ 权限汪可以删除 _应用_

权限汪需要知道服务器根据启动时 `DOGETOK` 环境变量设置的密码并在请求相应 __管理 API__ 时作为 cookie 参数 `doge_token` 填写

#### 用户 < 未登录用户

+ 用户不能创建 _用户_
+ 用户不能创建 _分类_
+ 用户可以 __创建__ 未禁止创建的 _实体_ 和 __修改/删除__ 自己所创建的 _实体_ 或 _notification 记录_
+ 用户可以 __登录 WebSocket 平台__

用户需要使用 _分发密码_ 创建一个自己的 _密码_（内部表示为 `passhash`）

在创建之后，用户也可以使用 _分发密码_（内部表示为 `metapass`）重置自己的密码

WebSocket 验证方式参见上文 _WebSocket API_，请求需要 _验证身份_ 的 API 时，必须携带 `geekapk_uid` 和 `geekapk_passhash` 两个 _cookie_ 来验证自己的身份，服务器 __不会猜测__ 你需要使用的用户身份

#### 未登录用户

除了 __只读访问__ 和 __登录 WebSocket 平台__ 外没有其它限制

## GeekApk 包含的 __对象__ 数据设计

| 中文名  |   实体名   |     表名     | __ID__ 名 | 描述
|    -    |    :-:     |     :-:      |    :-:    | -:
|用户     | _user_     | _users_      |     _uid_ | GeekApk 用户帐号
|分类     | _category_ | _categories_ |     _tid_ | GeekApk 应用分类
|应用     | _app_      | _apps_       |     _aid_ | GeekApk 应用
|评论     | _comment_  | _comments_   |     _cid_ | GeekApk 评论

对象的辅助表：

| 中文名   |     实体名     |       表名      | 所属对象 | 描述
|   -      |      :-:       |       :-:       |    :-:   | -:
| 跟随     |                |      follow     |  _用户_  | 用户跟随
| 密码     |                |   \_security    |  _用户_  | 用户密码
| 更新     |     update     |     updates     |  _应用_  | 应用更新
| 星标     |                |      stars      |  _应用_  | 应用星标
| 评论星标 |                |  comment_stars  |  _评论_  | 评论星标
| 时间线   | _timeline_     | _timelines_     |  _用户_  | 时间线记录
| 通知     | _notification_ | _notifications_ |  _用户_  | 通知条目

_用户_ 对象关系：

+ 只能有一个 _密码_
+ 可以有很多个 _应用_
+ 可以有很多条 _评论_
+ 可以有很多条 _跟随_
+ 可以有很多个 _星标_
+ 可以有很多个 _评论星标_
+ 可以有很多条 _时间线_
+ 可以有很多条 _通知_

_分类_ 对象关系：

+ 只能有一个 父 _分类_
+ 可以包含很多个 _应用_

_应用_ 对象关系：

+ 只能有一个创建人 _用户_
+ 只能有一个归属 _分类_
+ 可以有很多条 _评论_
+ 可以有很多条 _更新_
+ 可以有很多条 _星标_

_评论_ 对象关系：

+ 只能有一个创建人 _用户_
+ 只能有一个评论目标 _应用_
+ 只能有一个回复目标 _评论_
+ 可以有很多个 _评论星标_

排行设计：

+ _用户_ 可以按 __创建时间、上线时间、跟随者人数__ 排行
+ _应用_ 可以按 __创建时间、更新时间、星标数、评论数、体积__ 徘行
+ _评论_ 可以按 __创建时间、更新时间、评论星标数、回复数__ 排行

分页设计： __时间线、评论、用户、应用__ 可以设置返回的 __最大条数__

检索设计：

+ _用户_ 可以用 __简单名、用户名、别名、GitHub、自述、开发者自述__ 检索
+ _应用_ 可以用 __应用名、包名、描述__ 检索
+ _评论_ 可以用 __内容__ 检索

> 考虑到清晰度的原因，设计上不会添加 __rate limit__，但实践中有可能在文档规定外添加一定的限制
